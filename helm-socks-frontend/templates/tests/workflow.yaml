apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  name: "{{ include "helm-socks-frontend.name" . }}-workflow"
  annotations:
    argocd.argoproj.io/hook: PostSync
    # argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  entrypoint: check-service-up
  onExit: exit-handler
  templates:
  - name: check-service-up
    container:
      image: appropriate/curl
      command: ['curl']
      args:
        - '-vX GET'
        - 'helm-socks-frontend-int.sock-shop-front-end'

  - name: exit-handler
    steps:
    - - name: notify
        template: send-status-webhook
        arguments:
          parameters:
          - name: status
            value: "{{ `{{ workflow.status }}` }}"

  - name: send-status-webhook
    inputs:
      parameters:
      - name: status
    container:
      image: appropriate/curl
      command: ['curl']
      args:
        - '-vX POST'
        - '-H "Content-Type: application/json"'
        - '-d foo'
        - 'https://webhook.site/c1d94793-b1b1-424b-b412-3f429a6825bb'
